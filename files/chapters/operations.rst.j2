Operations Manual
=================

Inspect the status of the PKI
-----------------------------

To determine the status of the PKI, you can use *Enterprise PKI Viewer*.

#. Log in to ``{{ servers.issuing_ca.name }}`` using RDP.

#. Click on the start button, type ``pkiview.msc`` and press **Enter**.

#. Expand the tree on the left and click on your issuing CA.

#. Ensure that all entries are marked with *OK* in the *Status* column.

.. figure:: ../graphics/pkiview.png

      An example of what Enterprise PKI Viewer looks like for a fully-functional AD CS installation.

Back up the root CA
-------------------

Create a backup to disk using ``CertUtil``. The backup contains all issued certificates, the CA log, and the private key of the CA as a P12-file.

#. Turn on ``{{ servers.root_ca.name }}`` and log in using RDP.

#. Run the backup command and type in the password used to protect the private key::

    CertUtil -backup C:\Backup

#. Backup keys in the registry::

    reg export HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration C:\Backup\backup.reg

#. Transfer the backup directory ``C:\Backup`` to a secure location.

#. Turn off ``{{ servers.root_ca.name }}``.

Restore a backup of the root CA
-------------------------------

#. Turn on ``{{ servers.root_ca.name }}`` and log in using RDP.

#. Reset the server using SysPrep::

    %WINDIR%\system32\sysprep\sysprep.exe /generalize /reboot /oobe

When configuring Windows, configure the name of the server to be ``{{ servers.root_ca.name }}`` as specified in the backup file.

#. Transfer the latest backup directory ``C:\Backup`` to the root CA server.

#. Install the AD CS Windows feature::

    Install-WindowsFeature Adcs-Cert-Authority -IncludeManagementTools

#. Restore the CA certificate and private key::

    $BackupPassword = Read-Host -AsSecureString
    Install-AdcsCertificationAuthority -CAType StandaloneRootCa -CertFile 'C:\Backup\R1.p12' -CertFilePassword $BackupPassword -DatabaseDirectory $(Join-Path $env:SystemRoot "System32\CertLog") -Force

#. Restore the CA database using CertUtil::

    Remove-Item C:\Windows\System32\CertLog\* -Force
    CertUtil -restoreDB C:\Backup

#. Import the registry keys::

    reg import C:\Backup\backup.reg

#. Restart AD CS::

    net stop certsvc
    net start certsvc

#. Turn off ``{{ servers.root_ca.name }}``.

.. _issue root ca crl:

Issue a new root CA CRL
-----------------------

#. Turn on ``{{ servers.root_ca.name }}`` and log in using RDP.

#. Issue a CRL from the root CA::

    CertUtil -crl

{% for server in servers.repositories %}
#. Transfer the file ``C:\R1.crt`` to ``C:\inetpub\pki`` on {{ server.name }}.
{% endfor %}

#. Turn off ``{{ servers.root_ca.name }}``.

Renew an issuing CA
-------------------

Create a CSR
~~~~~~~~~~~~

#. Log in to ``{{ servers.issuing_ca.name }}`` using RDP.

#. Click on the Start button, type ``apps: certsrv`` and press **Enter**.

#. Right-click on ``ICA1`` in the tree on the left and click on **All Tasks → Renew CA Certificate**.

#. Windows will ask if you want to stop AD CS. Click **Yes** to stop AD CS and continue with the renewal.

#. You will now have the option to generate a new keypair. You should generate a new keypair if:

    - You suspect that the private key of the issuing CA may have been compromised.
    - There are a lot of revoked certificates on the CRL, and you want to start over with an empty CRL.
    - You need to switch to a new type of key.

#. Pick **Yes** or **No** according to your needs and click on **OK**.

#. Click on **Cancel** to save the CSR to disk and start AD CS again.

#. Transfer the file ``C:\ICA1.csr`` to ``{{ servers.root_ca.name }}``.

Sign the CA certificate
~~~~~~~~~~~~~~~~~~~~~~~

#. Log in to ``{{ servers.root_ca.name }}`` using RDP.

#. Submit the CSR for the issuing CA and save the request ID::

    $request = CertReq -submit -config - C:\ICA1.csr | Out-String | Select-String 'RequestId: (\d+)'
    $requestId = $request.Matches[0].Groups[1].Value.Trim()

#. Accept the request and retrieve a copy of the new issuing CA certificate::

    CertUtil -resubmit $requestId
    CertReq -retrieve -config - $requestId C:\ICA1.crt

#. Transfer the file ``C:\ICA1.crt`` to ``{{ servers.issuing_ca.name }}``.

Install the CA certificate
~~~~~~~~~~~~~~~~~~~~~~~~~~

#. Log in to ``{{ servers.issuing_ca.name }}`` using RDP.

#. Install the CA certificate::

    CertUtil -installcert "C:\ICA1.crt"

#. Restart AD CS::

    net stop certsvc
    net start certsvc

Revoke an issuing CA
--------------------

You should only revoke an issuing CA certificate if you suspect that the private key may have been compromised, as revoking a CA will cause all certificates issued from it to be invalidated.

#. If you are revoking the issuing CA currently being in use, you should :ref:`renew the issuing CA certificate <renew issuing ca>` first.

#. Log in to ``{{ servers.root_ca.name }}`` using RDP.

#. List the certificates issued by the root CA using CertUtil. Make a note of the serial number for the certificate you want to revoke.

CertUtil -out "Issued Common Name","Certificate Expiration date","Serial Number" -view Log csv

#. Revoke the certificate, replace ``serial number`` with the serial number of the certificate as reported by CertUtil.

    CertUtil -revoke "serial number"

#. Follow :ref:`the instructions to issue a new CRL from the root CA <issue root ca crl>`.

Revoke an enduser certificate
-----------------------------

TODO

Reenroll all certificate holders
--------------------------------

TODO

Manually enroll for a user certificate
--------------------------------------

#. Log in with the user with whom you want to enroll.

#. Click on the Start button, type ``mmc.exe`` and press **Enter**.

#. Press **Ctrl + M** and double-click on the **Certificates** snap-in.

#. If a dialog windows is shown, select **My user account** and click on **Finish**.

#. Click on **OK** to add the snap-in.

#. Right-click on **Certificates - Current User** in the panel on the right, and click on **All tasks → Automatically Enroll and Retrieve Certificates**. The *Certificate Enrollment* wizard opens.

#. Click on **Next** to start the wizard.

#. TODO

Manually enroll for a computer certificate
------------------------------------------

TODO